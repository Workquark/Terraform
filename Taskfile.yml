# https://taskfile.dev

version: '3'

vars:
  GREETING: Hello, World!

tasks:
  default:
    cmds:
      - echo "{{.GREETING}} {{.USER_NAME}}"
    silent: true

  install:
      - helm repo add argo https://argoproj.github.io/argo-helm
      - helm repo update
      - helm upgrade -i --wait argocd argo/argo-cd --version 7.8.13 -n argocd --create-namespace -f ./k8s/argocd/gcp/manifests/helmcharts/argocd/argocd.values.yaml
    
  configure:
    cmds:
      - kustomize build k8s/argocd/gcp/bootstrap | kubectl apply -f -

  destroy:
    dir: Terraform/GCP/env/dev # '{{.USER_WORKING_DIR}}'
    cmds:
      - ./destroy.sh

  ## GCP Export variables - For the setup task
  ## export PROJECT=$(gcloud config get project)
  ## export PROJECT_ID=$(gcloud projects describe $PROJECT --format="value(projectNumber)")
  
  prerequisites:
    cmds:
      - gcloud iam workload-identity-pools create "github" --project={{ .PROJECT }} --location="global" --display-name="github identity pool"
      - gcloud iam workload-identity-pools providers create-oidc "github-provider" \
          --project={{ .PROJECT }} \
          --location="global" \
          --workload-identity-pool="github" \
          --display-name="github action provider" \
          --attribute-mapping="google.subject=assertion.sub,attribute.actor=assertion.actor,attribute.aud=assertion.aud" \
          --issuer-uri="https://token.actions.githubusercontent.com" \
          --attribute-condition="assertion.repository_owner == {{ .REPO_OWNER }}"

      - gcloud iam service-accounts add-iam-policy-binding "github@{{ .PROJECT }}.iam.gserviceaccount.com" \
          --project={{ .PROJECT }} \
          --role="roles/iam.workloadIdentityUser" \
          --member="principalSet://iam.googleapis.com/projects/{{ .PROJECT_ID }}/locations/global/workloadIdentityPools/github/attribute.repository/${REPO}"

      -  gcloud iam roles create DnsCustomPolicy \
          --title="DNS Custom Policy" \
          --description="This role Allows you to set IAM policy for DNS Managed Zones" \
          --permissions="dns.managedZones.setIamPolicy" \
          --project=$PROJECT